{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ç—á–µ—Ç—ã - –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="panel glow-effect">
      <h1>üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—â–∏—Ö –æ—Ç—á–µ—Ç–æ–≤</h1>
      <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 2rem;">
        –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞–º–∏ –ø–æ –≤—Å–µ–º –æ–±—ä–µ–∫—Ç–∞–º –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º
      </p>
      <div style="text-align: center;">
        <a href="{% url 'dashboard' %}" style="display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
          <span style="font-size: 1.2rem;">üè†</span>
          <span>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥</span>
        </a>
      </div>
    </div>

    <div class="panel">
      <h2>üìà –¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
        <!-- –ü–µ—Ä–µ—á–Ω–∏ —Ä–∞–±–æ—Ç –ø–æ –æ–±—ä–µ–∫—Ç–∞–º -->
        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">üìã</div>
            <div>
              <h3 style="margin: 0; color: var(--text-primary);">–ü–µ—Ä–µ—á–Ω–∏ —Ä–∞–±–æ—Ç –ø–æ –æ–±—ä–µ–∫—Ç–∞–º</h3>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">–°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞</p>
            </div>
          </div>
          
          <!-- –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ -->
          <div id="objectSelectorSection" style="display: none; margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç:</h4>
            <select id="objectSelect" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); font-size: 1rem; margin-bottom: 1rem;">
              <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...</option>
            </select>
            <div style="display: flex; gap: 1rem;">
              <button id="generateWorkListButton" onclick="generateWorkListReport()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; position: relative; overflow: hidden;">
                <span id="generateWorkListText">üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</span>
                <div id="generateWorkListLoader" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                  <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
              </button>
              <button onclick="hideObjectSelector()" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
          
          <button id="mainGenerateButton" onclick="showObjectSelector()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
            üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
          </button>
        </div>

        <!-- –ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç -->
        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">üîß</div>
            <div>
              <h3 style="margin: 0; color: var(--text-primary);">–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç</h3>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞–±–æ—Ç</p>
            </div>
          </div>
             <button id="workListsButton" onclick="generateWorkListsReport()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
               <span id="workListsText">üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</span>
               <div id="workListsLoader" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                 <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
               </div>
             </button>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">üìà</div>
            <div>
              <h3 style="margin: 0; color: var(--text-primary);">–ì—Ä–∞—Ñ–∏–∫–∏</h3>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
            </div>
          </div>
             <button id="chartsButton" onclick="generateChartsReport()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
               <span id="chartsText">üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</span>
               <div id="chartsLoader" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                 <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
               </div>
             </button>
        </div>

      </div>
    </div>

  </div>


  <script>
    let objects = [];

    function showObjectSelector() {
      const section = document.getElementById('objectSelectorSection');
      const mainButton = document.getElementById('mainGenerateButton');
      section.style.display = 'block';
      mainButton.style.display = 'none';
      loadObjects();
    }

    function hideObjectSelector() {
      const section = document.getElementById('objectSelectorSection');
      const mainButton = document.getElementById('mainGenerateButton');
      section.style.display = 'none';
      mainButton.style.display = 'block';
    }

    async function loadObjects() {
      try {
        const response = await fetch('https://building-api.itc-hub.ru/api/v1/objects', {
          headers: {
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          objects = data.items || [];
          const select = document.getElementById('objectSelect');
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç...</option>';
          
          objects.forEach(obj => {
            const option = document.createElement('option');
            option.value = obj.id;
            option.textContent = `${obj.name} (ID: ${obj.id})`;
            select.appendChild(option);
          });
        } else {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤');
        }
      } catch (error) {
        document.getElementById('objectSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤</option>';
      }
    }

    async function generateWorkListReport() {
      const objectId = document.getElementById('objectSelect').value;
      if (!objectId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç!');
        return;
      }

      const selectedObject = objects.find(obj => obj.id == objectId);
      if (!selectedObject) {
        alert('–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }

      const button = document.getElementById('generateWorkListButton');
      const text = document.getElementById('generateWorkListText');
      const loader = document.getElementById('generateWorkListLoader');

      text.style.display = 'none';
      loader.style.display = 'block';
      button.disabled = true;

      try {
        const response = await fetch(`https://building-api.itc-hub.ru/api/v1/work-plans/list?object_id=${objectId}`, {
          headers: {
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç');
        }

        const data = await response.json();
        const workPlans = data.items || [];
        
        let allWorkItems = [];
        workPlans.forEach(plan => {
          if (plan.work_items && plan.work_items.length > 0) {
            allWorkItems = allWorkItems.concat(plan.work_items);
          }
        });

        if (allWorkItems.length === 0) {
          alert(`–î–ª—è –æ–±—ä–µ–∫—Ç–∞ "${selectedObject.name}" –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç`);
          return;
        }

        generateExcelReport(selectedObject, allWorkItems);
        hideObjectSelector();

      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      } finally {
        text.style.display = 'block';
        loader.style.display = 'none';
        button.disabled = false;
      }
    }

    function generateExcelReport(object, workItems) {
      // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ —á—Ç–æ –∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
      const excelData = [];
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
      excelData.push(['', '', '', '', '', '', '']);
      
      // –î–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç
      workItems.forEach(item => {
        const row = [
          item.name || '', // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
          item.quantity || '', // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
          item.unit || '', // –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
          item.start_date || '', // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
          item.end_date || '', // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
          object.address || object.name, // –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
          object.address || object.name  // –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ (–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è)
        ];
        excelData.push(row);
      });

      // –°–æ–∑–¥–∞–µ–º CSV —Ñ–∞–π–ª (–ø—Ä–æ—â–µ —á–µ–º Excel)
      let csvContent = '';
      excelData.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `–ü–µ—Ä–µ—á–µ–Ω—å_—Ä–∞–±–æ—Ç_${object.name.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9\s]/g, '').replace(/\s+/g, '_')}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
    }

    async function generateWorkListsReport() {
      console.log('generateWorkListsReport –≤—ã–∑–≤–∞–Ω–∞');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
      const button = document.getElementById('workListsButton');
      const text = document.getElementById('workListsText');
      const loader = document.getElementById('workListsLoader');
      
      button.disabled = true;
      text.style.opacity = '0';
      loader.style.display = 'block';
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
        const objectsResponse = await fetch('https://building-api.itc-hub.ru/api/v1/objects', {
          headers: {
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
            'Content-Type': 'application/json'
          }
        });

        if (!objectsResponse.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤');
        }

        const objectsData = await objectsResponse.json();
        const objects = objectsData.items || [];
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        let allWorkItems = [];
        
        for (const object of objects) {
          try {
            const workResponse = await fetch(`https://building-api.itc-hub.ru/api/v1/work-plans/list?object_id=${object.id}`, {
              headers: {
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
                'Content-Type': 'application/json'
              }
            });

            if (workResponse.ok) {
              const workData = await workResponse.json();
              const workPlans = workData.items || [];
              
              workPlans.forEach(plan => {
                if (plan.work_items && plan.work_items.length > 0) {
                  plan.work_items.forEach(workItem => {
                    allWorkItems.push({
                      ...workItem,
                      object: object
                    });
                  });
                }
              });
            }
          } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
          }
        }

        if (allWorkItems.length === 0) {
          alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
          return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Excel —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç –°–û–ö –æ–±—â–∏–π –ò–¢–û–ì"
        generateWorkListsExcel(allWorkItems);
        
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        button.disabled = false;
        text.style.opacity = '1';
        loader.style.display = 'none';
      }
    }

    async function generateChartsReport() {
      console.log('generateChartsReport –≤—ã–∑–≤–∞–Ω–∞');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
      const button = document.getElementById('chartsButton');
      const text = document.getElementById('chartsText');
      const loader = document.getElementById('chartsLoader');
      
      button.disabled = true;
      text.style.opacity = '0';
      loader.style.display = 'block';
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
        const objectsResponse = await fetch('https://building-api.itc-hub.ru/api/v1/objects', {
          headers: {
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
            'Content-Type': 'application/json'
          }
        });

        if (!objectsResponse.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤');
        }

        const objectsData = await objectsResponse.json();
        const objects = objectsData.items || [];
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let chartsData = [];
        
        for (const object of objects) {
          try {
            const workResponse = await fetch(`https://building-api.itc-hub.ru/api/v1/work-plans/list?object_id=${object.id}`, {
              headers: {
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiNmVmYmJlMy1lMGM0LTRkOTYtYWI2NC0zYWJkNDQ3MzIyYTUiLCJyb2xlIjoiZm9yZW1hbiIsInR5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjE0MDA4NTYsImlhdCI6MTc2MDc5NjA1Nn0.SJAiNPWOLmdk--1pWK4bbIuKsaipt4yLQ-1UTVonSJE',
                'Content-Type': 'application/json'
              }
            });

            if (workResponse.ok) {
              const workData = await workResponse.json();
              const workPlans = workData.items || [];
              
              let objectWorkItems = [];
              workPlans.forEach(plan => {
                if (plan.work_items && plan.work_items.length > 0) {
                  plan.work_items.forEach(workItem => {
                    objectWorkItems.push(workItem);
                  });
                }
              });

              if (objectWorkItems.length > 0) {
                chartsData.push({
                  object: object,
                  workItems: objectWorkItems
                });
              }
            }
          } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
          }
        }

        if (chartsData.length === 0) {
          alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤');
          return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Excel —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ì—Ä–∞—Ñ–∏–∫–∏"
        generateChartsExcel(chartsData);
        
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        button.disabled = false;
        text.style.opacity = '1';
        loader.style.display = 'none';
      }
    }

    function generateWorkListsExcel(workItems) {
      console.log('generateWorkListsExcel –≤—ã–∑–≤–∞–Ω–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç:', workItems.length);
      // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç –°–û–ö –æ–±—â–∏–π –ò–¢–û–ì"
      const excelData = [];
      
      // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
      excelData.push(['', '', '', '', '', '', '', '', '', '']);
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      excelData.push([
        'ID',
        '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã',
        '–ê–¥—Ä–µ—Å',
        '–û–±—ä–µ–º',
        '–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π',
        '–ö–ü–ì–ó',
        '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
        '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
        '–°—É—â–Ω–æ—Å—Ç—å –ì–ü–†',
        ''
      ]);
      
      // –î–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç
      workItems.forEach((item, index) => {
        const row = [
          item.id || `ID_${index + 1}`,
          item.name || '',
          item.object.address || item.object.name || '',
          item.quantity || '',
          item.unit || '',
          '02.03.03.11', // –ö–ü–ì–ó - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          item.start_date || '',
          item.end_date || '',
          item.name || '', // –°—É—â–Ω–æ—Å—Ç—å –ì–ü–† = –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
          ''
        ];
        excelData.push(row);
      });

      // –°–æ–∑–¥–∞–µ–º CSV —Ñ–∞–π–ª
      let csvContent = '';
      excelData.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      console.log('–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', '–ü–µ—Ä–µ—á–µ–Ω—å_—Ä–∞–±–æ—Ç_–°–û–ö_–æ–±—â–∏–π_–ò–¢–û–ì.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      console.log('–ö–ª–∏–∫–∞–µ–º –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...');
      link.click();
      document.body.removeChild(link);
      
      alert('–û—Ç—á–µ—Ç "–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç" —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
    }

    function generateChartsExcel(chartsData) {
      // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ì—Ä–∞—Ñ–∏–∫–∏"
      const excelData = [];
      
      chartsData.forEach((chart, chartIndex) => {
        // –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        excelData.push([chart.object.address || chart.object.name, '', '', '']);
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        excelData.push(['‚Ññ', '–≠—Ç–∞–ø —Ä–∞–±–æ—Ç', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è']);
        
        // –î–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç –¥–ª—è –æ–±—ä–µ–∫—Ç–∞
        chart.workItems.forEach((item, index) => {
          const row = [
            index + 1,
            item.name || '',
            item.start_date || '',
            item.end_date || ''
          ];
          excelData.push(row);
        });
        
        // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)
        if (chartIndex < chartsData.length - 1) {
          excelData.push(['', '', '', '']);
        }
      });

      // –°–æ–∑–¥–∞–µ–º CSV —Ñ–∞–π–ª
      let csvContent = '';
      excelData.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', '–ì—Ä–∞—Ñ–∏–∫–∏.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('–û—Ç—á–µ—Ç "–ì—Ä–∞—Ñ–∏–∫–∏" —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
    }

    function generateReport(type) {
      if (type === 'work_lists_by_objects') {
        showObjectSelector();
        return;
      }
      
      const reportTypes = {
        'work_lists': '–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç',
        'charts': '–ì—Ä–∞—Ñ–∏–∫–∏'
      };
      
      const reportName = reportTypes[type] || '–û—Ç—á–µ—Ç';
      
      if (confirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ${reportName}?`)) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        button.disabled = true;
        
        // –ò–º–∏—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞
        setTimeout(() => {
          alert(`${reportName} —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!`);
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      }
    }
  </script>
</body>
</html>
